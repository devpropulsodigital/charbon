{% assign progress_bar_color = settings.shipping_bar_color %}
{% assign active_levels = settings.active_levels %}
{% assign hide_message_before_and_amount = settings.hide_message_before_and_amount %}
{% assign text_custom_progress_bar = settings.text_custom_progress_bar %}
{% assign font_family = settings.font_family %}

{%- style  %}

  {{  settings.font_family | font_face: font_display: 'swap' }}
  
  .upsell-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    padding-bottom: 2rem;
    background-color: {{ settings.upsell_background_color }};
  }

  /* Container that holds both the progress bar and the circles */
  .progress-bar-container {
    position: relative;
    width: 100%;
    height: 0.6rem; 
    display: flex;
    align-items: center;
    padding-left: 20px;
    padding-right: 20px;
  }

  /* Progress bar styling */
  .progress-bar {
    position: relative;
    background-color: #E2E4E3;
    height: 100%; 
    width: 100%;
    border-radius: 0.75em;
    padding: 3px;
    overflow: hidden;
  }

  .progress-bar-done {
    content: "";
    position: absolute;
    left: 0;
    top: 0;
    width: var(--progress-start); 
    height: 100%; 
    background: {{ progress_bar_color }}; 
    border-radius: 3rem; 
    animation: widthProgress 2s ease forwards; 
    {% if settings.shipping_bar_gradient contains 'linear-gradient' %}
      background: {{ settings.shipping_bar_gradient }}; 
    {% else %}
      background: {{ settings.shipping_bar_color }}; 
    {% endif %}
  }

  /* Keyframes pour l'animation de progression */
  @keyframes widthProgress {
    from {
      width: var(--progress-start); 
    }
    to {
      width: var(--progress-end);
    }
  }

  /* Style for progress circles */
  .progress-circle {
    position: absolute;
    top: auto;
    width: 1.6rem;
    height: 1.6rem;
    background-color: white;
    border: 2px solid {{ progress_bar_color }};
    border-radius: 50%;
    transform: translateX(-50%);
    z-index: 2;
  }

  .free_shipping_notice {
    margin-bottom: 1rem;
  }

  .shipping-message {
    margin: 10px 20px;
    line-height: normal;
    text-align: center;
    font-size: {{ settings.font_size }}rem;
    color: {{ settings.text_color }};
  }

  {% if text_custom_progress_bar %}
     .shipping-message {
      font-family: {{ font_family.family }}, {{ font_family.fallback_families }};
      font-weight: {{ font_family.weight }};
      font-style: {{ font_family.style }};
      }
  {% endif %}  
  
  @keyframes pulsecercle {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(62, 101, 207, 0.7);
  }
  50% {
    transform: scale(1.2);
    box-shadow: 0 0 0 10px rgba(62, 101, 207, 0);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(62, 101, 207, 0);
  }
}

.pulsecercle {
  animation: pulsecercle 1.5s infinite;
}

{%- endstyle  %}

<div class="upsell-container">
  {% assign level_1_value = settings.shipping_level_1 | times: 100 %}
  {% assign level_2_value = settings.shipping_level_2 | times: 100 %}
  {% assign level_3_value = settings.shipping_level_3 | times: 100 %}
  
  {% assign cart_total = cart.original_total_price %}
  
  {% assign level_1_left = level_1_value | minus: cart_total %}
  {% assign level_2_left = level_2_value | minus: cart_total %}
  {% assign level_3_left = level_3_value | minus: cart_total %}
  
  <!-- Calcul de la progression -->
  {% assign progress_percentage = 0 %}
  
  {% if active_levels == 1 %}
    {% assign progress_percentage = cart_total | times: 100 | divided_by: level_1_value %}
  
  {% elsif active_levels == 2 %}
    {% if cart_total < level_1_value %}
      {% assign progress_percentage = cart_total | times: 50 | divided_by: level_1_value %}
    {% elsif cart_total < level_2_value %}
      {% assign level_range = level_2_value | minus: level_1_value %}
      {% assign progress_within_level = cart_total | minus: level_1_value %}
      {% assign progress_percentage = progress_within_level | times: 50 | divided_by: level_range %}
      {% assign progress_percentage = progress_percentage | plus: 50 %}
    {% else %}
      {% assign progress_percentage = 100 %}
    {% endif %}

  {% elsif active_levels == 3 %}
    {% if cart_total < level_1_value %}
      {% assign progress_percentage = cart_total | times: 33.33 | divided_by: level_1_value %}
    {% elsif cart_total < level_2_value %}
      {% assign level_range = level_2_value | minus: level_1_value %}
      {% assign progress_within_level = cart_total | minus: level_1_value %}
      {% assign progress_percentage = progress_within_level | times: 33.33 | divided_by: level_range %}
      {% assign progress_percentage = progress_percentage | plus: 33.33 %}
    {% elsif cart_total < level_3_value %}
      {% assign level_range = level_3_value | minus: level_2_value %}
      {% assign progress_within_level = cart_total | minus: level_2_value %}
      {% assign progress_percentage = progress_within_level | times: 33.33 | divided_by: level_range %}
      {% assign progress_percentage = progress_percentage | plus: 66.66 %}
    {% else %}
      {% assign progress_percentage = 100 %}
    {% endif %}
  {% endif %}

  <!-- Limiter la progression à 100% -->
  {% if progress_percentage > 100 %}
    {% assign progress_percentage = 100 %}
  {% endif %}

  <!-- Affichage du message de progression -->
  <p class="shipping-message">
    {% if active_levels >= 1 %}
      {% if cart_total < level_1_value %}
        {% unless hide_message_before_and_amount %}
          <span class="free_shipping_notice">{{ settings.shipping_level_1_message_before }} {{ level_1_left | money }} {{ settings.shipping_level_1_message_after }}</span>
        {% else %}
          <span class="free_shipping_notice">{{ settings.shipping_level_1_message_before }}</span>
        {% endunless %}
      {% elsif active_levels == 1 %}
        <span class="free_shipping_notice">{{ settings.shipping_level_1_success_message }}</span>
      {% endif %}
    {% endif %}

    {% if active_levels >= 2 and cart_total >= level_1_value %}
      {% if cart_total < level_2_value %}
        {% unless hide_message_before_and_amount %}
          <span class="free_shipping_notice">{{ settings.shipping_level_1_success_message }}<br><br>{{ settings.shipping_level_2_message_before }} {{ level_2_left | money }} {{ settings.shipping_level_2_message_after }}</span>
        {% else %}
          <span class="free_shipping_notice">{{ settings.shipping_level_1_success_message }}<br><br>{{ settings.shipping_level_2_message_before }}</span>
        {% endunless %}
      {% elsif active_levels == 2 %}
        <span class="free_shipping_notice">{{ settings.shipping_level_2_success_message }}</span>
      {% endif %}
    {% endif %}

    {% if active_levels >= 3 and cart_total >= level_2_value %}
      {% if cart_total < level_3_value %}
        {% unless hide_message_before_and_amount %}
          <span class="free_shipping_notice">{{ settings.shipping_level_2_success_message }}<br><br>{{ settings.shipping_level_3_message_before }} {{ level_3_left | money }} {{ settings.shipping_level_3_message_after }}</span>
        {% else %}
          <span class="free_shipping_notice">{{ settings.shipping_level_2_success_message }}<br><br>{{ settings.shipping_level_3_message_before }}</span>
        {% endunless %}
      {% else %}
        <span>{{ settings.shipping_level_3_success_message }}</span>
      {% endif %}
    {% endif %}
  </p>

  <!-- Progress bar container -->
  <div class="progress-bar-container">
    <!-- Progress bar -->
    <div class="progress-bar">&nbsp;
      <!-- Appliquer ici l'animation CSS -->
      <div class="progress-bar-done" style="--progress-start: 0%; --progress-end: {{ progress_percentage }}%;">&nbsp;</div>
    </div>

    <!-- Display Circles for Levels -->
  {% if active_levels == 1 %}
    <!-- Un seul niveau, le cercle à 93% -->
    <div class="progress-circle {% if cart_total >= level_1_value %} pulsecercle {% endif %}" style="left: 93%;">&nbsp;</div>
  {% elsif active_levels == 2 %}
    <!-- Deux niveaux, cercles à 46% et 93% -->
    <div class="progress-circle {% if cart_total >= level_1_value %} pulsecercle {% endif %}" style="left: 46%;">&nbsp;</div>
    <div class="progress-circle {% if cart_total >= level_2_value %} pulsecercle {% endif %}" style="left: 93%;">&nbsp;</div>
  {% elsif active_levels == 3 %}
    <!-- Trois niveaux, cercles à 31%, 62%, et 93% -->
    <div class="progress-circle {% if cart_total >= level_1_value %} pulsecercle {% endif %}" style="left: 31%;">&nbsp;</div>
    <div class="progress-circle {% if cart_total >= level_2_value %} pulsecercle {% endif %}" style="left: 62%;">&nbsp;</div>
    <div class="progress-circle {% if cart_total >= level_3_value %} pulsecercle {% endif %}" style="left: 93%;">&nbsp;</div>
  {% endif %}
</div>
</div>